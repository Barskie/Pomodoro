<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routines - Pivot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel='stylesheet' href="../style.css">
    
</head>
<body>
    <div id="nav-placeholder">
    </div>

    <!-- ROUTINES -->

    <div class="container px-5 py-5 mx-auto">
        <div class="container d-flex justify-content-around ">
            <div class = "row">
            <span class = "titleRoutine text-center">
                ROUTINES
                <hr class="solid" id="hrWhite2">
            </span>
        </div>
        </div>
       
    <section class ="timer">
        <div class="container px-5 py-1 mx-auto">

            <!-- ONE ROUTINE !-->
            <div class = "row justify-content-md-center text-center mx-auto mt-4" id="display_routines">

               
            </div>
    </section>

          



    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="sweetalert2.min.css">

    <script>
    $.get("../navigationBar.html", function(data){
        $("#nav-placeholder").replaceWith(data);
        });
    </script>
   
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
   <script>

    function myFunction(i) {
      document.getElementById("myDropdown1"+i).classList.toggle("show");
    }
    displayRoutines()
    window.onclick = function(event) {
      if (!event.target.matches('.dropbtn1')) {
        var dropdowns = document.getElementsByClassName("dropdown-content1");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }
    window.onload = function() {
    if(!window.location.hash) {
        window.location = window.location + '#loaded';
        window.location.reload();
    }
    window.onpageshow = function (event) {
        if (event.persisted) {
            window.location.reload(); 
        }
        };
    }
    
    
    if(!localStorage.getItem('user_id')){
        Swal.fire({
                title: 'LOGIN FIRST!', 
                confirmButtonColor: "#783937",
                text: "Before proceeding, log-in or create an account. ",
                icon: 'error',
                confirmButtonText: 'OK'
            }).then(function() {
                window.location = "../user/login.html";
             });
            
        }


    function displayRoutines(){
        $.ajax({
                type:"POST",
                url: "../api/display_routine.php",
                dataType: "json",
                data:{
                    user_id: localStorage.getItem('user_id'),
                },
                
                cache:false,
                success: function(dataResult){
                    
                
                    var innerHtml = ''
                    for(let i = 0; i < dataResult.length; i++){
                        innerHtml+='<div class="card routinesCard">'
                        innerHtml+='<div class = "color text-center">'
                        innerHtml+='<div class = "card-header routineHeader">'
                        innerHtml+='<div class = "row  justify-content-md-center text-center" id ="accordionSession'+i+'">'
                        innerHtml+='<div class = "col-8 text-left">'
                        innerHtml+='<div class = "sessionListName">'
                        innerHtml+='<span class ="routineName1" value="">'+dataResult[i].routine_name+'</span>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='<div class ="col-1 text-right ">'
                        innerHtml+='<div class = "dropdown1" >'
                        innerHtml+='<button onclick="myFunction('+i+')" class="dropbtn1"><i class="fa fa-cog" id="routineDrop1'+i+'" style="color: white"></i></button>'
                        innerHtml+='<div id="myDropdown1'+i+'" class="dropdown-content1">'
                        innerHtml+='<a class="dropdown-item" href="#" onclick="passIdToConvertSession('+"'"+dataResult[i].id['$oid']+"'"+')">Convert to Session</a>'
                        innerHtml+='<a class="dropdown-item" href="viewRoutine.html?'+dataResult[i].id['$oid']+'">View Routine</a>'
                        innerHtml+='<a class="dropdown-item" href="editRoutine.html?'+dataResult[i].id['$oid']+'">Edit Routine</a>'
                        innerHtml+='<a class="dropdown-item" href="#" onclick = "removeRoutine('+"'"+dataResult[i].id['$oid']+"'"+')">Delete Routine</a>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='<div class ="col-1 text-right">'
                        innerHtml+='<button class = "btn moreBtn" id = "collapsible"  data-toggle="collapse" data-target="#sessionCollapse'+i+'" aria-expanded="true" aria-controls="collapseOne'+i+'">'
                        innerHtml+='<i class="fa fa-angle-down" id="sessionsIcons2"></i>'
                        innerHtml+='</button>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='<div id="sessionCollapse'+i+'" class="collapse" aria-labelledby="headingOne'+i+'" data-parent="#accordionSession'+i+'">'
                        innerHtml+='<div class = "card-body subRoutinesBody">'
                        innerHtml+='<div class = "row text-center">'
                        innerHtml+='<div class = "subRoutinesInfo">'
                        innerHtml+='<div class = "row">'
                        innerHtml+='<div class = "col-10 text-left">'
                        innerHtml+='<span class = "subRoutinesInfoText">TIME PER SESSION: </span>'
                        innerHtml+='</div>'
                        innerHtml+='<div class = "col-2 text-center">'
                        innerHtml+='<span class = "subRoutinesInfoText">'+dataResult[i].pomodoro+':00 </span>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='<div class = "row">'
                            for(let x = 0; x < dataResult[i].session_task.length; x++){
                                innerHtml+='<div class = "indivSubRoutines">'
                                innerHtml+='<div class = "row">'
                                innerHtml+='<div class = "col-12 text-center">'
                                innerHtml+='<span class = "subRoutinesInfoText">'+dataResult[i].session_task[x].name+'</span>'
                                innerHtml+='</div>'
                                innerHtml+='</div>'
                                innerHtml+='</div>'
                            }
                        
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                        innerHtml+='</div>'
                    }
                    $('#display_routines').html(innerHtml);

                },error:function(err){
            console.log('error')		 
            }
        })
        


    }
    function passIdToConvertSession(res){
           
            localStorage.setItem('routineId',res)
            
            window.location.href = "../routineTimer.html";
            window.location.reload ="../routineTimer.html";
        }
    function removeRoutine(res){
        Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#783937',
        confirmButtonText: 'CONFIRM'
    }).then((result) => {
        if (result.isConfirmed) {
        $.ajax({
                type:"POST",
                url: "../api/delete_routine.php",
                dataType: "json",
                 data:{
                    routineId: res
                },
                
                cache:false,
                success: function(dataResult){
                    Swal.fire({
                    title: 'ROUTINE DELETED', 
                    confirmButtonColor: "#783937",
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(function() {
                    location.reload();
                });
                
       
                  
                },error:function(err){
              console.log('error')		 
            }
            })
       }})}
       
    </script>
   


</body>
</html>