<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate User Reports - Pivot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel='stylesheet' href="../style.css">
    
</head>
<body>
    <div id="nav-placeholder">
    </div>

    <div class="container px-5 py-4 mx-auto">
        <div class="container d-flex justify-content-around ">
            <div class = "row">
            <span class = "titleRoutine text-center">
                GENERATE USER REPORTS
                <hr class="solid" id="hrWhite2">
            </span>
        </div>
        </div>
        <!-- SUMMARY OF ROUTINE -->
        <button onClick = "window.location.href='allUserAccs.html'" class="btn-block btn-color" id = "print_btn">PRINT REPORTS</button>
        <div class="container d-flex justify-content-around ">
            <div class = "row text-center">
                <div class = "col-lg-3">
                    <div class = "row">
                        <div class = "card adminInfoReports">
                            <span class = "titleRoutine1">
                               ALL USERS
                            </span>
                            <hr class = "hrWhite">
                            <div class = "row">
                                <div class = "col-2">
                            <input id="checked_all" type="checkbox" onclick="checked_all_func()" checked></div><div class = "col-10"><span>SELECT ALL USERS</span></div>
                        </div>
                            <!-- ONE USER DETAIL -->
                            <div class = "row  text-center mb-1 mt-2" id = "adminScrollReports">
                              
                               
                                
                            </div>
                            <!-- END -->
        
                            
                          
                        </div>
                        
                    </div>
                    <div class = "reportsButtons">
                    <div class = "row text-center">
                        <button onClick = "window.location.href='allUserAccs.html'" class="btn-block btn-color" id = "routine_btn">VIEW ALL USERS</button>
                        
                        <!-- <button class="btn-block btn-color" id = "routine_btn">SELECT USERS</button> -->
                        <button onClick = "window.location.href='dashboard.html'"  class="btn-block btn-color" id = "routine_btn">BACK</button></div>
                    
                   </div>
                </div>
                   
                <!-- SUB ROUTINES -->
                <div class = "col-lg-9">
                    <div class = "card reportsCard">
                        <div class = "row">
                            <div class = "col-6">
                                <div class = "row">
                                    <span class = "titleReports text-right">
                                        DATE STARTED:
                                    </span>
                                    <div class = "col text-right mb-3">
                                        <input type="date" id="start_date" class = "dateReportS">
                                    </div>
                                </div>   
                            </div>
                            <div class = "col-6">
                                <div class = "row">
                                    <span class = "titleReports text-left">
                                        DATE ENDED:
                                    </span>
                                    <div class = "col text-left">
                                        <input type="date" id="end_date" class = "dateReportS">
                                    </div>
                                </div>   
                            </div>
                            <div class = "row text-center">
                                <div class = "col mb-4">
                                    <button type = "button" class = "btn" onClick = "showReports()" id = "reportsSort">SORT
                                    </button>
                                </div>

                            </div>
                       
                            <hr class = "hrWhite">
                            <div class = "col-6">
                                <div class = "row">
                                    <span class = "titleReports text-center">
                                        NO. OF TASKS COMPLETED:
                                    </span>
                                    <div class = "summaryNo text-center" id = "todoSummary1">
                                        10
                                    </div>
                                </div> 
                             </div>
                             <div class = "col-6">
                                <div class = "row">
                                    <span class = "titleReports text-center">
                                        NO. OF ROUTINES COMPLETED:
                                    </span>
                                    <div class = "summaryNo text-center" id = "routineSummary">
                                        10
                                    </div>
                                </div> 
                             </div>
                        </div>
                       
                        <hr class = "hrWhite">
                        <span class = "titleReports text-left">
                            TASK COMPLETED
                        </span>
                        <div class = "reportsTableCard">
                            <table class="table table-striped">
                                <thead>
                                  <tr>
                                    <th>#</th>
                                    <th>EMAIL ADDRESS</th>
                                    <th>TIME PER SESSION</th>
                                    <th>NO. OF SUBTASKS</th>
                                    <th>TIME/DATE COMPLETED</th>
                                  </tr>
                                </thead>
                                <tbody id="task">
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <!-- END OF ONE TASK REPORT -->
                                </tbody>
                            </table>
                        </div>
                        <hr class = "hrWhite">
                        <span class = "titleReports text-left">
                            ROUTINES COMPLETED
                        </span>
                        <div class = "reportsTableCard">
                            <table class="table table-striped">
                                <thead>
                                  <tr>
                                    <th scope="col-2">#</th>
                                    <th colspan="2">EMAIL ADDRESS</th>
                                    <th>TIME PER SESSION</th>
                                    <th>NO. OF SUBTASKS</th>
                                    <th>NO. OF TIMES</th>
                                  </tr>
                                </thead>
                                <tbody id="routine">
                                    <!-- ONE ROUTINE REPORT -->
                                  <tr>
                                    <td colspan="2" class = "text-left"></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <!-- END OF ONE ROUTINE REPORT -->
                                </tbody>
                            </table>
                        </div>
                        <hr class = "hrWhite">
                        <span class = "titleReports text-left">
                            ASSESSMENTS COMPLETED
                        </span>
                        <div class = "reportsTableCard">
                            <table class="table table-striped">
                                <thead>
                                  <tr>
                                    <th scope="">#</th>
                                    <th colspan="">EMAIL ADDRESS</th>
                                    <th scope="">POINTS</th>
                                    <th scope="">TIME/DATE COMPLETED</th>
                                    
                                  </tr>
                                </thead>
                                <tbody id="assessments">
                                    <!-- ONE ROUTINE REPORT -->
                                  <tr>
                                    
                                    <td></td>
                                    <td colspan="2" class = "text-left"></td>
                                    <td></td>
                                    <td colspan="2" class = "text-left"></td>
                                  </tr>
                                  <!-- END OF ONE ROUTINE REPORT -->
                                </tbody>
                            </table>
                        </div>


                                


                    </div>
                </div>
           
            </div>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script>
    $.get("../navigationBar.html", function(data){
        $("#nav-placeholder").replaceWith(data);
        });
    </script>
     <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
     <script>
     var is_all = true//para hindi lang mag reset yung check box
     var search_id = true
     var search_is = 1212
         window.onload = function() {
     if(!window.location.hash) {
         window.location = window.location + '#loaded';
         window.location.reload();
     }
     if(window.location.search){
        const queryString = window.location.search
        search_is = queryString.substring(1)
        is_all = false
        search_id = true
        document.getElementById("checked_all").checked = false;
     }else{
        is_all = true
        search_id = false
     }
     showUsers()
     
     window.onpageshow = function (event) {
         if (event.persisted) {
             window.location.reload(); //reload page if it has been loaded from cache
         }
         };
     }

     
     if(!localStorage.getItem('user_id')||localStorage.getItem('emailAdd')!="pivotacc.pomodoro@gmail.com"){
       
 
             window.location = "../timer.html";
         };
         var userIdArray = []
         function showUsers(){
            console.log(search_is)
                $.ajax({
                    type:"POST",
                    url: "../api/admin_viewuser.php",
                    dataType: "json",
                    data:{
                        search: ''
                    },
                    cache:false,
                    success: function(dataResult){

                        var innerHtml = ''
                        console.log(dataResult)

                        for (let i = 0 ; dataResult.length > i ; i++){
                            if(dataResult[i].email!='pivotacc.pomodoro@gmail.com'){
                                innerHtml += '<div class = "col-10 summaryNameCol">'
                                innerHtml += '<div class = "row">'
                                innerHtml += '<div class = "col-2">'
                                if(is_all || (dataResult[i]._id['$oid'] == search_is && search_id) ){
                                    userIdArray.push(dataResult[i]._id['$oid'])
                                    innerHtml += '<input type="checkbox" onchange="user_id_to_array('+"'"+dataResult[i]._id['$oid']+"'"+')" class = "reportsCheck" checked>'
                                }else{
                                    innerHtml += '<input type="checkbox" onchange="user_id_to_array('+"'"+dataResult[i]._id['$oid']+"'"+')" class = "reportsCheck">'
                                }
                                innerHtml += '</div>'
                                innerHtml += '<div class = "col-10">'
                                innerHtml += '<span style= "font-size: 18px">'+dataResult[i].Lname+'</span>'
                                innerHtml += '</div>'
                                innerHtml += '<div class = "col-2">'
                                innerHtml += '</div>'
                                innerHtml += '<div class = "col-10">'
                                innerHtml += '<short>'+dataResult[i].email+'</short>'
                                innerHtml += '</div>'
                                innerHtml += '</div>'
                                innerHtml += '</div>'
                            }

                        }
                        is_all = false
                        search_id = false
                        showReports()
                        $('#adminScrollReports').html(innerHtml)
                    },error:function(err){
                        console.log(err)
                    }
                })
                
            }  
        function checked_all_func(){
            if(document.getElementById('checked_all').checked){
                is_all = true
                showUsers()
            }
        }
            
        function user_id_to_array(id){
            document.getElementById("checked_all").checked = false;
            var is_push = true;
            // for(let i = 0; userIdArray.length > i; i++){
            //     if(userIdArray[i] == id){
            //         is_push = false
            //     }
            // }
            const index = userIdArray.indexOf(id);
            if (index > -1) { // only splice array when item is found
                userIdArray.splice(index, 1); // 2nd parameter means remove one item only
            }else{
                userIdArray.push(id)
            }
            showReports()

        }
        var start_date = document.getElementById('start_date').value
                var end_date = document.getElementById('end_date').value

                if(start_date == '' && end_date == ''){
                    end_date_default = dateToday();
                    var end_date = document.getElementById('end_date').value = end_date_default
                    start_date_default =  getLastWeeksDate();
                    var start_date = document.getElementById('start_date').value = start_date_default
                    showReports()

                } else {
                    showReports()
                }
                
                function getLastWeeksDate() {
                    const now = new Date();

                    var dtLastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    var month = dtLastWeek.getMonth() + 1;
                    var day = dtLastWeek.getDate();
                    var year = dtLastWeek.getFullYear();
                    var hr = dtLastWeek.getHours();
                    var min = dtLastWeek.getMinutes();
                    if(month < 10)
                        month = '0' + month.toString();
                    if(day < 10)
                        day = '0' + day.toString();
                    var lastWeek = year + '-' + month + '-' + day;
                    
                    return lastWeek
                }
                function dateToday(){
                    var dtToday = new Date();
                    var month = dtToday.getMonth() + 1;
                    var day = dtToday.getDate();
                    var year = dtToday.getFullYear();
                    var hr = dtToday.getHours();
                    var min = dtToday.getMinutes();
                    if(month < 10)
                        month = '0' + month.toString();
                    if(day < 10)
                        day = '0' + day.toString();
                    var todayDate = year + '-' + month + '-' + day;
                    return todayDate
                }

        
        function showReports(){
                // var params = []
                $.ajax({
                    type:"POST",
                    url: "../api/admin_reports.php",
                    dataType: "json",
                    data:{
                        end_date: document.getElementById('end_date').value,
                        start_date: document.getElementById('start_date').value,
                        user_id: userIdArray,
                    },
                    
                    cache:false,
                    success: function(dataResult){
                        var arrayAssessments = dataResult.assessments;
                        var arrayTask = dataResult.task;
                        var arrayRoutine = dataResult.routine;
                        console.log(dataResult)

                        var innerHtmlAssessments = ''
                        var innerHtmlTask = ''
                        var innerHtmlRoutine = ''
                        var innerHtmlTodoSummary = ''
                        var innerHtmlRoutineModal = ''
                        var innerHtmlRoutineSummary = ''
                        
                        
                        for(let i = 0; dataResult.assessments.length > i; i++){
                            innerHtmlAssessments+='<tr>'
                            innerHtmlAssessments+='<td>'+parseInt(i+1)+'</td>'
                            innerHtmlAssessments+='<td>'+arrayAssessments[i].email+'</td>'
                            innerHtmlAssessments+='<td>'+arrayAssessments[i].points+'</td>'
                            innerHtmlAssessments+='<td>'+arrayAssessments[i].date_created+'/'+arrayAssessments[i].time_created+'</td>'
                            innerHtmlAssessments+='</tr>'
                        }
                        for(let i = 0; dataResult.task.length > i; i++){
                            todoSum = i;
                            innerHtmlTask+='<tr>'
                            innerHtmlTask+='<td class = "text-left">'+parseInt(i+1)+'</td>'
                            innerHtmlTask+='<td>'+arrayTask[i].email+'</td>'
                            innerHtmlTask+='<td>'+arrayTask[i].pomodoro+':00</td>'
                            innerHtmlTask+='<td>'+arrayTask[i].subtask_no+'</td>'
                            innerHtmlTask+='<td>'+arrayTask[i].end_date+'/'+arrayTask[i].end_time+'</td>'
                            innerHtmlTask+='</tr>'
                            
                        }
                        for(let i = 0; dataResult.routine.length > i; i++){
                            if(arrayRoutine[i].times_done){
                            innerHtmlRoutine += '<tr>'
                            innerHtmlRoutine += '<td colspan="2" class = "text-left">'+parseInt(i+1)+'</td>'
                            innerHtmlRoutine += '<td>'+arrayRoutine[i].email+'</td>'
                            innerHtmlRoutine += '<td>'+arrayRoutine[i].pomodoro+':00</td>'
                            innerHtmlRoutine += '<td>'+arrayRoutine[i].subtask_no+'</td>'
                            innerHtmlRoutine += '<td>'+arrayRoutine[i].times_done+'</td>'

                            innerHtmlRoutine += '</tr>'
                            innerHtmlRoutineModal+='<div class = "modal fade " id="viewMoreModal'+i+'" role="dialog">'
                            innerHtmlRoutineModal+='<div class = "modal-dialog  modal-xl modal-dialog-scrollable">'
                            innerHtmlRoutineModal+='<div class = "modal-content">'
                            innerHtmlRoutineModal+='<div class = "modal-header text-center d-block  "><h4 class="modal-title  d-inline-block">'+arrayRoutine[i].routine_name+'</h4></div>'
                            innerHtmlRoutineModal+='<div class = "modal-body">'
                            innerHtmlRoutineModal+='<div class = "row  justify-content-md-center text-center">'
                            innerHtmlRoutineModal+='<div class = "col-8 text-center">'
                            innerHtmlRoutineModal+='<div class = "reportsTableCard1">'
                            innerHtmlRoutineModal+='<table class="table table-striped">'
                            innerHtmlRoutineModal+='<thead>'
                            innerHtmlRoutineModal+='<tr>'
                            innerHtmlRoutineModal+='<th colspan="2">ROUTINE NAME</th>'
                            innerHtmlRoutineModal+='<th scope="col-2">TIME PER SESSION</th>'
                            innerHtmlRoutineModal+=' <th scope="col-2">NO. OF SUBTASKS</th>'
                            // innerHtmlRoutineModal+='<th scope="col-2">NO. OF TIMES</th></th>'
                            innerHtmlRoutineModal+=' <th scope="col-2">TIME/DATE COMPLETED'
                            innerHtmlRoutineModal+='</tr>'
                            innerHtmlRoutineModal+='<tbody>'
                                for(let x = 0; dataResult.routine[i].history.length > x; x++){
                                    innerHtmlRoutineModal += '<tr>'
                                    innerHtmlRoutineModal += '<td colspan="2" class = "text-left">'+dataResult.routine[i].history[x].routine_name+'</td>'
                                    innerHtmlRoutineModal += '<td>'+dataResult.routine[i].history[x].pomodoro+':00</td>'
                                    innerHtmlRoutineModal += '<td>'+dataResult.routine[i].history[x].no_of_task+'</td>'
                                    // innerHtmlRoutineModal += '<td>'+dataResult.routine[i].history[x]+'</td>'
                                    innerHtmlRoutineModal += '<td>'+dataResult.routine[i].history[x].end_date+'</td>'
                                    innerHtmlRoutineModal += '</tr>'
                                }
                            
                            innerHtmlRoutineModal+='</tbody>'
                            innerHtmlRoutineModal+=' </table>'
                            innerHtmlRoutineModal+=' </div>'



                        innerHtmlRoutineModal+='</div>'
                    innerHtmlRoutineModal+='</div>'
                    innerHtmlRoutineModal+='</div>'
                    innerHtmlRoutineModal+='</div>'
                    innerHtmlRoutineModal+='</div>'
                    innerHtmlRoutineModal+='</div>'
                            }
                        }

                            // console.log(arrayRoutine)
                        
                            innerHtmlTodoSummary+=dataResult.task.length
                            innerHtmlRoutineSummary += dataResult.routine.length
                            
                        $('#task').html(innerHtmlTask)
                        $('#assessments').html(innerHtmlAssessments)
                        $('#routine').html(innerHtmlRoutine)
                        $('#todoSummary1').html(innerHtmlTodoSummary)
                    
                        $('#routineSummary').html(innerHtmlRoutineSummary)
                        $('#viewMoreModal2').html(innerHtmlRoutineModal)

                    },error:function(err){
                        console.log('error')		 
                    }
                })
            }
             
        
 
     </script>
   


</body>
</html>